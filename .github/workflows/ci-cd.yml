name: CI/CD Pipeline

on:
  push:
    branches:
      - 'release-*'  # Triggers on push to release branches
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      # Inputs dari GitHub App (optional - untuk tracking)
      target_owner:
        description: 'Target repository owner'
        required: false
        type: string
      target_repo:
        description: 'Target repository name'
        required: false
        type: string
      target_branch:
        description: 'Target branch'
        required: false
        type: string
      session_id:
        description: 'Session ID'
        required: false
        type: string
      repo_url:
        description: 'Repository URL'
        required: false
        type: string
      commit_sha:
        description: 'Commit SHA (optional)'
        required: false
        type: string
      project_type:
        description: 'Project type (optional)'
        required: false
        type: string
      features:
        description: 'Features list (optional)'
        required: false
        type: string
      # Existing input (keep for manual trigger)
      environment:
        description: 'Deployment environment'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  JAVA_VERSION: '17'
  KOTLIN_VERSION: '1.9.20'

jobs:
  # Detect project type and configuration
  detect-project:
    name: Detect Project Configuration
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.project_type }}
      has_android: ${{ steps.detect.outputs.has_android }}
      has_ios: ${{ steps.detect.outputs.has_ios }}
      enable_firebase: ${{ steps.config.outputs.enable_firebase }}
      enable_unit_tests: ${{ steps.config.outputs.enable_unit_tests }}
      tester_groups: ${{ steps.config.outputs.tester_groups }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use target_branch if provided (from workflow_dispatch), otherwise use default
          ref: ${{ inputs.target_branch || github.ref }}
      
      - name: Log workflow inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ“‹ Workflow Inputs:"
          echo "  Target: ${{ inputs.target_owner }}/${{ inputs.target_repo }}"
          echo "  Branch: ${{ inputs.target_branch }}"
          echo "  Session: ${{ inputs.session_id }}"
          echo "  Project Type: ${{ inputs.project_type }}"
          echo "  Features: ${{ inputs.features }}"
          echo "  Commit SHA: ${{ inputs.commit_sha }}"
          echo "  Environment: ${{ inputs.environment }}"
      
      - name: Detect project type
        id: detect
        run: |
          HAS_ANDROID=false
          HAS_IOS=false
          PROJECT_TYPE="unknown"
          
          # Use provided project_type if available, otherwise detect
          if [ -n "${{ inputs.project_type }}" ]; then
            PROJECT_TYPE="${{ inputs.project_type }}"
            echo "ðŸ“± Using provided project type: $PROJECT_TYPE"
            
            # Set has_android/has_ios based on provided type
            if [ "$PROJECT_TYPE" = "android" ] || [ "$PROJECT_TYPE" = "multiplatform" ]; then
              HAS_ANDROID=true
            fi
            if [ "$PROJECT_TYPE" = "ios" ] || [ "$PROJECT_TYPE" = "multiplatform" ]; then
              HAS_IOS=true
            fi
          else
            # Auto-detect (existing logic)
            # Check for Android
            if [ -d "composeApp" ] || [ -f "build.gradle.kts" ] || [ -f "build.gradle" ]; then
              HAS_ANDROID=true
              echo "âœ“ Android project detected"
            fi
            
            # Check for iOS
            if [ -d "iosApp" ] || [ -f "iosApp/iosApp.xcodeproj/project.pbxproj" ]; then
              HAS_IOS=true
              echo "âœ“ iOS project detected"
            fi
            
            # Determine project type
            if [ "$HAS_ANDROID" = true ] && [ "$HAS_IOS" = true ]; then
              PROJECT_TYPE="multiplatform"
              echo "ðŸ“± Project type: Kotlin Multiplatform (Android + iOS)"
            elif [ "$HAS_ANDROID" = true ]; then
              PROJECT_TYPE="android"
              echo "ðŸ¤– Project type: Android"
            elif [ "$HAS_IOS" = true ]; then
              PROJECT_TYPE="ios"
              echo "ðŸŽ Project type: iOS"
            else
              PROJECT_TYPE="web"
              echo "ðŸŒ Project type: Web"
            fi
          fi
          
          echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
          echo "has_android=$HAS_ANDROID" >> $GITHUB_OUTPUT
          echo "has_ios=$HAS_IOS" >> $GITHUB_OUTPUT

      - name: Read workflow configuration
        id: config
        run: |
          # Default values
          ENABLE_FIREBASE=false
          ENABLE_UNIT_TESTS=true
          TESTER_GROUPS="testers"
          
          # Read from workflow-config.json if exists
          if [ -f ".github/workflow-config.json" ]; then
            echo "ðŸ“„ Reading configuration from workflow-config.json"
            # Parse JSON (requires jq, fallback to grep if not available)
            if command -v jq &> /dev/null; then
              ENABLE_FIREBASE=$(jq -r '.firebase.enable_firebase_distribution // false' .github/workflow-config.json)
              ENABLE_UNIT_TESTS=$(jq -r '.testing.enable_unit_tests // true' .github/workflow-config.json)
              # Read tester_groups array and convert to comma-separated string
              TESTER_GROUPS=$(jq -r '.firebase.tester_groups // ["testers"] | join(",")' .github/workflow-config.json)
            else
              # Fallback: simple grep-based parsing
              if grep -q '"enable_firebase_distribution".*true' .github/workflow-config.json; then
                ENABLE_FIREBASE=true
              fi
              if grep -q '"enable_unit_tests".*false' .github/workflow-config.json; then
                ENABLE_UNIT_TESTS=false
              fi
            fi
            echo "ðŸ”¥ Firebase Distribution: $ENABLE_FIREBASE"
            echo "ðŸ§ª Unit Tests: $ENABLE_UNIT_TESTS"
            echo "ðŸ‘¥ Tester Groups: $TESTER_GROUPS"
          else
            echo "âš ï¸  No workflow-config.json found, using defaults"
          fi
          
          echo "enable_firebase=$ENABLE_FIREBASE" >> $GITHUB_OUTPUT
          echo "enable_unit_tests=$ENABLE_UNIT_TESTS" >> $GITHUB_OUTPUT
          echo "tester_groups=$TESTER_GROUPS" >> $GITHUB_OUTPUT

  # Build Android if detected
  build-android:
    name: Build Android
    needs: detect-project
    if: needs.detect-project.outputs.has_android == 'true'
    uses: ./.github/workflows/build-android.yml
    with:
      enable_firebase: ${{ needs.detect-project.outputs.enable_firebase == 'true' }}
      enable_unit_tests: ${{ needs.detect-project.outputs.enable_unit_tests == 'true' }}
      tester_groups: ${{ needs.detect-project.outputs.tester_groups }}
    secrets: inherit

  # Build iOS if detected
  build-ios:
    name: Build iOS
    needs: detect-project
    if: needs.detect-project.outputs.has_ios == 'true'
    uses: ./.github/workflows/build-ios.yml
    with:
      enable_firebase: ${{ needs.detect-project.outputs.enable_firebase == 'true' }}
      enable_unit_tests: ${{ needs.detect-project.outputs.enable_unit_tests == 'true' }}
      tester_groups: ${{ needs.detect-project.outputs.tester_groups }}
    secrets: inherit

  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-project, build-android, build-ios]
    if: always()
    steps:
      - name: Check build results
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.session_id }}" ]; then
            echo "**Session ID:** ${{ inputs.session_id }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Project Type:** ${{ needs.detect-project.outputs.project_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Android status
          if [ "${{ needs.detect-project.outputs.has_android }}" = "true" ]; then
            ANDROID_STATUS="${{ needs.build-android.result }}"
            if [ "$ANDROID_STATUS" = "success" ]; then
              echo "âœ… Android Build: **Success**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Android Build: **Failed**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # iOS status
          if [ "${{ needs.detect-project.outputs.has_ios }}" = "true" ]; then
            IOS_STATUS="${{ needs.build-ios.result }}"
            if [ "$IOS_STATUS" = "success" ]; then
              echo "âœ… iOS Build: **Success**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ iOS Build: **Failed**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Firebase Distribution: ${{ needs.detect-project.outputs.enable_firebase }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.detect-project.outputs.enable_unit_tests }}" >> $GITHUB_STEP_SUMMARY

